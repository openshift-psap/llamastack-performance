apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: cleanup
  namespace: tekton-llamastack
spec:
  description: |
    Cleanup all deployed resources after testing.
    Removes vLLM, MCP server, LlamaStack, and PostgreSQL.
  params:
    - name: NAMESPACE
      description: Namespace to cleanup
      type: string
      default: "llamastack"
    - name: DISTRIBUTION_NAME
      description: Name of the LlamaStackDistribution to delete
      type: string
      default: "llamastack-benchmark"
    - name: MODEL_NAME
      description: Name of the vLLM InferenceService to delete
      type: string
      default: "llama-32-3b-instruct"
    - name: MCP_SERVER_NAME
      description: Name of the MCP server deployment to delete
      type: string
      default: "sdg-docs-mcp-server"
    - name: SKIP_CLEANUP
      description: Set to "true" to skip cleanup (for debugging)
      type: string
      default: "false"
    - name: CLEANUP_VLLM
      description: Set to "true" to also cleanup vLLM
      type: string
      default: "false"
    - name: CLEANUP_MCP
      description: Set to "true" to also cleanup MCP server
      type: string
      default: "false"
    - name: DELETE_NAMESPACE
      description: Set to "true" to delete the entire namespace
      type: string
      default: "false"
  steps:
    - name: cleanup
      image: quay.io/openshift/origin-cli:latest
      script: |
        #!/bin/bash
        set -e
        
        if [ "$(params.SKIP_CLEANUP)" = "true" ]; then
          echo "Skipping cleanup (SKIP_CLEANUP=true)"
          exit 0
        fi
        
        echo "=============================================="
        echo "Cleaning up resources"
        echo "=============================================="
        echo "Namespace: $(params.NAMESPACE)"
        echo ""
        
        # Delete LlamaStack
        echo "Deleting LlamaStackDistribution..."
        oc delete llamastackdistribution $(params.DISTRIBUTION_NAME) -n $(params.NAMESPACE) --ignore-not-found=true
        
        # Delete PostgreSQL
        echo "Deleting PostgreSQL..."
        oc delete deployment postgres -n $(params.NAMESPACE) --ignore-not-found=true
        oc delete service postgres -n $(params.NAMESPACE) --ignore-not-found=true
        oc delete pvc postgres-pvc -n $(params.NAMESPACE) --ignore-not-found=true
        oc delete secret postgres-secret -n $(params.NAMESPACE) --ignore-not-found=true
        
        # Delete OTel Collector
        echo "Deleting OTel Collector..."
        oc delete deployment otel-collector -n $(params.NAMESPACE) --ignore-not-found=true
        oc delete service otel-collector -n $(params.NAMESPACE) --ignore-not-found=true
        oc delete configmap otel-collector-config -n $(params.NAMESPACE) --ignore-not-found=true
        
        # Optionally delete MCP server
        if [ "$(params.CLEANUP_MCP)" = "true" ]; then
          echo "Deleting MCP server..."
          oc delete deployment $(params.MCP_SERVER_NAME) -n $(params.NAMESPACE) --ignore-not-found=true
          oc delete service $(params.MCP_SERVER_NAME) -n $(params.NAMESPACE) --ignore-not-found=true
        else
          echo "Skipping MCP server cleanup (CLEANUP_MCP=false)"
        fi
        
        # Optionally delete vLLM
        if [ "$(params.CLEANUP_VLLM)" = "true" ]; then
          echo "Deleting vLLM InferenceService..."
          oc delete inferenceservice $(params.MODEL_NAME) -n $(params.NAMESPACE) --ignore-not-found=true
          oc delete servingruntime $(params.MODEL_NAME) -n $(params.NAMESPACE) --ignore-not-found=true
        else
          echo "Skipping vLLM cleanup (CLEANUP_VLLM=false)"
        fi
        
        # Optionally delete entire namespace
        if [ "$(params.DELETE_NAMESPACE)" = "true" ]; then
          echo "Deleting namespace $(params.NAMESPACE)..."
          oc delete namespace $(params.NAMESPACE) --ignore-not-found=true
        fi
        
        echo ""
        echo "=============================================="
        echo "Cleanup complete!"
        echo "=============================================="
