apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: run-locust
  namespace: tekton-llamastack
spec:
  description: |
    Run Locust load test against LlamaStack or vLLM.
    Mounts locustfiles from ConfigMap, writes all result files to shared workspace.
    HPA metrics sidecar collects pod/HPA metrics during the test.
  params:
    - name: HOST
      description: Target URL to test
      type: string
    - name: USERS
      description: Number of concurrent users
      type: string
      default: "10"
    - name: SPAWN_RATE
      description: Users to spawn per second
      type: string
      default: "1"
    - name: RUN_TIME_SECONDS
      description: Test duration in seconds
      type: string
      default: "60"
    - name: MCP_SERVER
      description: MCP server URL for tool calling
      type: string
      default: "http://sdg-docs-mcp-server.llamastack.svc.cluster.local:8000/sse"
    - name: MODEL
      description: Model name to use
      type: string
      default: "vllm-inference/llama-32-3b-instruct"
    - name: PROMPT
      description: Test prompt
      type: string
      default: "What is Kubernetes?"
    - name: LOAD_SHAPE
      description: "Load shape: steady | spike | realistic | custom"
      type: string
      default: "steady"
    - name: LOCUST_IMAGE
      description: Locust container image
      type: string
      default: "quay.io/rh-ee-tosokin/locust-openai:v2-mlflow"
    - name: CUSTOM_STAGES
      description: JSON array of stages for custom load shape
      type: string
      default: "[]"
    - name: EXTRA_ENV
      description: "Additional env vars for shapes (KEY=VALUE per line)"
      type: string
      default: ""
    - name: USER_CLASS
      description: "User class: ResponsesMCPUser | ResponsesSimpleUser | ChatCompletionsUser"
      type: string
      default: "ResponsesMCPUser"
    - name: NAMESPACE
      description: Namespace where LlamaStack is deployed (for HPA scraper)
      type: string
      default: "llamastack-bench"
    - name: DISTRIBUTION_NAME
      description: LlamaStackDistribution name (for HPA scraper pod filter)
      type: string
      default: "llamastack-benchmark"
    - name: HPA_POST_TEST_SECONDS
      description: Seconds to continue scraping HPA metrics after test ends
      type: string
      default: "30"
  workspaces:
    - name: results
      description: Shared workspace for test result files (PVC-backed)
  steps:
    - name: setup-and-run
      image: $(params.LOCUST_IMAGE)
      env:
        - name: USERS
          value: $(params.USERS)
        - name: SPAWN_RATE
          value: $(params.SPAWN_RATE)
        - name: RUN_TIME_SECONDS
          value: $(params.RUN_TIME_SECONDS)
        - name: MCP_SERVER
          value: $(params.MCP_SERVER)
        - name: MODEL
          value: $(params.MODEL)
        - name: PROMPT
          value: $(params.PROMPT)
        - name: LOAD_SHAPE
          value: $(params.LOAD_SHAPE)
        - name: CUSTOM_STAGES
          value: $(params.CUSTOM_STAGES)
        - name: USER_CLASS
          value: $(params.USER_CLASS)
        - name: LOCUST_OUTPUT_DIR
          value: "$(workspaces.results.path)"
        - name: HPA_POST_TEST_SECONDS
          value: $(params.HPA_POST_TEST_SECONDS)
      script: |
        #!/bin/bash
        set -e

        echo "=============================================="
        echo "LlamaStack Locust Performance Test"
        echo "=============================================="
        echo "Host: $(params.HOST)"
        echo "Users: $USERS"
        echo "Spawn Rate: $SPAWN_RATE"
        echo "Duration: $RUN_TIME_SECONDS seconds"
        echo "User Class: $USER_CLASS"
        echo "MCP Server: $MCP_SERVER"
        echo "Model: $MODEL"
        echo "Load Shape: $LOAD_SHAPE"
        echo "Output Dir: $LOCUST_OUTPUT_DIR"
        echo "=============================================="

        # Create directory structure from ConfigMap
        mkdir -p /tmp/locustfiles/shapes /tmp/locustfiles/hooks

        # Copy files from ConfigMap mount
        cp /configmap/locustfile_main.py /tmp/locustfiles/
        cp /configmap/locustfile_users.py /tmp/locustfiles/
        cp /configmap/shapes_init.py /tmp/locustfiles/shapes/__init__.py
        cp /configmap/shapes_steady.py /tmp/locustfiles/shapes/steady.py
        cp /configmap/shapes_spike.py /tmp/locustfiles/shapes/spike.py
        cp /configmap/shapes_realistic.py /tmp/locustfiles/shapes/realistic.py
        cp /configmap/shapes_custom.py /tmp/locustfiles/shapes/custom.py
        cp /configmap/hooks_init.py /tmp/locustfiles/hooks/__init__.py
        cp /configmap/hooks_metrics_collector.py /tmp/locustfiles/hooks/metrics_collector.py

        echo "Locustfiles setup complete:"
        find /tmp/locustfiles -type f
        echo ""

        # Export extra environment variables (shape-specific params)
        export EXTRA_ENV='$(params.EXTRA_ENV)'
        EXTRA_ENV_VALUE='$(params.EXTRA_ENV)'
        if [ -n "$EXTRA_ENV_VALUE" ]; then
          echo "Extra environment variables:"
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              export "$line"
              echo "  $line"
            fi
          done <<< "$EXTRA_ENV_VALUE"
          echo ""
        fi

        # Record test start time (for trace analysis window)
        date +%s > "$LOCUST_OUTPUT_DIR/test_start_epoch"

        # Run Locust with CSV output to shared workspace
        cd /tmp/locustfiles
        locust -f locustfile_main.py \
          --host $(params.HOST) \
          --headless \
          --only-summary \
          --csv "$LOCUST_OUTPUT_DIR/locust-results"

        # Record test end time
        date +%s > "$LOCUST_OUTPUT_DIR/test_end_epoch"

        echo ""
        echo "=============================================="
        echo "Test Complete â€” waiting for HPA metrics"
        echo "=============================================="

        # Signal to HPA sidecar that test is done
        touch /shared/locust_complete

        # Wait for HPA sidecar to finish post-test collection
        WAIT_MAX=$((HPA_POST_TEST_SECONDS + 15))
        WAITED=0
        while [ $WAITED -lt $WAIT_MAX ]; do
          if [ -f /shared/hpa_done ]; then
            echo "HPA collection complete"
            break
          fi
          sleep 2
          WAITED=$((WAITED + 2))
        done

        # Copy HPA metrics to workspace
        if [ -f /shared/hpa-metrics.jsonl ]; then
          cp /shared/hpa-metrics.jsonl "$LOCUST_OUTPUT_DIR/hpa-metrics.jsonl"
          echo "HPA metrics copied to workspace"
        else
          echo "WARNING: No HPA metrics file found"
        fi

        echo ""
        echo "Result files:"
        ls -la "$LOCUST_OUTPUT_DIR/"
      volumeMounts:
        - name: locustfiles
          mountPath: /configmap
        - name: shared
          mountPath: /shared
  sidecars:
    - name: hpa-metrics-scraper
      image: nicolaka/netshoot:latest
      env:
        - name: NAMESPACE
          value: $(params.NAMESPACE)
        - name: POST_TEST_SECONDS
          value: $(params.HPA_POST_TEST_SECONDS)
        - name: DISTRIBUTION_NAME
          value: $(params.DISTRIBUTION_NAME)
      script: |
        #!/bin/bash
        HPA_FILE="/shared/hpa-metrics.jsonl"
        SIGNAL_FILE="/shared/locust_complete"
        TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        API_SERVER="https://kubernetes.default.svc"
        SAMPLE=0
        POST_COUNTER=0
        LOCUST_DONE=false
        PHASE="during_test"

        while true; do
          SAMPLE=$((SAMPLE + 1))
          TIMESTAMP=$(date -Iseconds)

          RAW_METRICS=$(curl -sk -H "Authorization: Bearer $TOKEN" \
            "$API_SERVER/apis/metrics.k8s.io/v1beta1/namespaces/$NAMESPACE/pods" 2>/dev/null || echo "{}")

          METRICS=$(echo "$RAW_METRICS" | jq -c "[.items[]? | select(.metadata.name | startswith(\"$DISTRIBUTION_NAME\")) | {
            pod: .metadata.name,
            memory_ki: (.containers[0].usage.memory | rtrimstr(\"Ki\") | tonumber // 0),
            cpu_n: (.containers[0].usage.cpu | rtrimstr(\"n\") | tonumber // 0)
          }]" 2>/dev/null || echo "[]")

          POD_COUNT=$(echo "$METRICS" | jq 'length' 2>/dev/null || echo "0")
          AVG_MEM=$(echo "$METRICS" | jq 'if length > 0 then ([.[].memory_ki] | add / length | floor) else 0 end' 2>/dev/null || echo "0")
          AVG_CPU=$(echo "$METRICS" | jq 'if length > 0 then ([.[].cpu_n] | add / length | floor) else 0 end' 2>/dev/null || echo "0")

          HPA_RAW=$(curl -sk -H "Authorization: Bearer $TOKEN" \
            "$API_SERVER/apis/autoscaling/v2/namespaces/$NAMESPACE/horizontalpodautoscalers" 2>/dev/null || echo "{}")
          HPA=$(echo "$HPA_RAW" | jq -c ".items[]? | select(.metadata.name | contains(\"llamastack\")) | {
            currentReplicas: .status.currentReplicas,
            desiredReplicas: .status.desiredReplicas,
            currentMemoryPct: (.status.currentMetrics[]? | select(.resource.name==\"memory\") | .resource.current.averageUtilization),
            currentCPUPct: (.status.currentMetrics[]? | select(.resource.name==\"cpu\") | .resource.current.averageUtilization)
          }" 2>/dev/null || echo "{}")
          [ -z "$HPA" ] && HPA="{}"

          if [ -f "$SIGNAL_FILE" ] && [ "$LOCUST_DONE" = "false" ]; then
            LOCUST_DONE=true
          fi
          [ "$LOCUST_DONE" = "true" ] && PHASE="post_test" && POST_COUNTER=$((POST_COUNTER + 1))

          echo "{\"timestamp\":\"$TIMESTAMP\",\"sample\":$SAMPLE,\"phase\":\"$PHASE\",\"pod_count\":$POD_COUNT,\"avg_memory_ki\":$AVG_MEM,\"avg_cpu_n\":$AVG_CPU,\"hpa\":$HPA}" >> "$HPA_FILE"

          if [ "$LOCUST_DONE" = "true" ] && [ $POST_COUNTER -ge ${POST_TEST_SECONDS:-30} ]; then
            touch /shared/hpa_done
            break
          fi

          sleep 1
        done
      volumeMounts:
        - name: shared
          mountPath: /shared
  volumes:
    - name: locustfiles
      configMap:
        name: locustfiles
    - name: shared
      emptyDir: {}
