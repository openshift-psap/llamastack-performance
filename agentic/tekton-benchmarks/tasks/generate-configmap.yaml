apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: generate-configmap
  namespace: tekton-llamastack
spec:
  description: |
    Generates ConfigMaps from Python source files in git.
    Creates: locustfiles (Locust code) and mlflow-scripts (MLflow logger + trace analyzer).
  params:
    - name: GIT_REPO
      description: Git repository URL
      type: string
      default: "https://github.com/openshift-psap/llamastack-performance.git"
    - name: GIT_BRANCH
      description: Git branch
      type: string
      default: "main"
    - name: CONFIGMAP_NAME
      description: Name of the ConfigMap to create/update
      type: string
      default: "locustfiles"
    - name: CONFIGMAP_NAMESPACE
      description: Namespace for the ConfigMap
      type: string
      default: "tekton-llamastack"
  steps:
    - name: clone-repo
      image: alpine/git:latest
      script: |
        #!/bin/sh
        set -e
        echo "Cloning $(params.GIT_REPO) (branch: $(params.GIT_BRANCH))..."
        git clone --depth 1 --branch $(params.GIT_BRANCH) $(params.GIT_REPO) /workspace/repo
        echo "Source files:"
        find /workspace/repo/agentic/tekton-benchmarks/locustfiles -name '*.py' -type f
        find /workspace/repo/agentic/tekton-benchmarks/scripts -name '*.py' -type f
      volumeMounts:
        - name: shared
          mountPath: /workspace

    - name: create-configmap
      image: quay.io/openshift/origin-cli:latest
      script: |
        #!/bin/bash
        set -e
        cd /workspace/repo/agentic/tekton-benchmarks/locustfiles

        echo "Generating ConfigMap $(params.CONFIGMAP_NAME)..."
        oc create configmap $(params.CONFIGMAP_NAME) \
          --from-file=locustfile_main.py=locustfile_main.py \
          --from-file=locustfile_users.py=locustfile_users.py \
          --from-file=shapes_init.py=shapes/__init__.py \
          --from-file=shapes_steady.py=shapes/steady.py \
          --from-file=shapes_spike.py=shapes/spike.py \
          --from-file=shapes_realistic.py=shapes/realistic.py \
          --from-file=shapes_custom.py=shapes/custom.py \
          --from-file=hooks_init.py=hooks/__init__.py \
          --from-file=hooks_metrics_collector.py=hooks/metrics_collector.py \
          --dry-run=client -o yaml | \
          oc apply -f - -n $(params.CONFIGMAP_NAMESPACE)

        echo "ConfigMap $(params.CONFIGMAP_NAME) generated"

        # Generate mlflow-scripts ConfigMap
        cd /workspace/repo/agentic/tekton-benchmarks/scripts

        echo "Generating ConfigMap mlflow-scripts..."
        oc create configmap mlflow-scripts \
          --from-file=trace_analyzer.py=trace_analyzer.py \
          --from-file=mlflow_logger.py=mlflow_logger.py \
          --dry-run=client -o yaml | \
          oc apply -f - -n $(params.CONFIGMAP_NAMESPACE)

        echo "Both ConfigMaps generated in $(params.CONFIGMAP_NAMESPACE)"
        oc get configmap locustfiles mlflow-scripts -n $(params.CONFIGMAP_NAMESPACE)
      volumeMounts:
        - name: shared
          mountPath: /workspace

  volumes:
    - name: shared
      emptyDir: {}
