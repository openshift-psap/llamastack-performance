apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: generate-configmap
  namespace: tekton-llamastack
spec:
  description: |
    Generates the locustfiles ConfigMap from Python source files in git.
    Run this task whenever locustfiles/ code changes.
  params:
    - name: GIT_REPO
      description: Git repository URL
      type: string
      default: "https://github.com/openshift-psap/llamastack-performance.git"
    - name: GIT_BRANCH
      description: Git branch
      type: string
      default: "main"
    - name: CONFIGMAP_NAME
      description: Name of the ConfigMap to create/update
      type: string
      default: "locustfiles"
    - name: CONFIGMAP_NAMESPACE
      description: Namespace for the ConfigMap
      type: string
      default: "tekton-llamastack"
  steps:
    - name: generate
      image: quay.io/openshift/origin-cli:latest
      script: |
        #!/bin/bash
        set -e

        echo "=============================================="
        echo "Generating locustfiles ConfigMap"
        echo "=============================================="
        echo "Repo: $(params.GIT_REPO)"
        echo "Branch: $(params.GIT_BRANCH)"
        echo ""

        # Clone repo
        cd /tmp
        git clone --depth 1 --branch $(params.GIT_BRANCH) $(params.GIT_REPO) repo
        cd repo/agentic/tekton-benchmarks/locustfiles

        echo "Source files:"
        find . -name '*.py' -type f
        echo ""

        # Generate ConfigMap from Python files
        # Keys use underscores instead of slashes (ConfigMap key restriction)
        oc create configmap $(params.CONFIGMAP_NAME) \
          --from-file=locustfile_main.py=locustfile_main.py \
          --from-file=locustfile_users.py=locustfile_users.py \
          --from-file=shapes_init.py=shapes/__init__.py \
          --from-file=shapes_steady.py=shapes/steady.py \
          --from-file=shapes_spike.py=shapes/spike.py \
          --from-file=shapes_realistic.py=shapes/realistic.py \
          --from-file=shapes_custom.py=shapes/custom.py \
          --from-file=hooks_init.py=hooks/__init__.py \
          --from-file=hooks_mlflow.py=hooks/mlflow_hooks.py \
          --dry-run=client -o yaml | \
          oc apply -f - -n $(params.CONFIGMAP_NAMESPACE)

        echo ""
        echo "=============================================="
        echo "ConfigMap generated successfully!"
        echo "=============================================="
        echo "Name: $(params.CONFIGMAP_NAME)"
        echo "Namespace: $(params.CONFIGMAP_NAMESPACE)"
        echo ""

        # Verify
        oc get configmap $(params.CONFIGMAP_NAME) -n $(params.CONFIGMAP_NAMESPACE) -o jsonpath='{.data}' | python3 -c "import sys,json; keys=json.load(sys.stdin).keys(); print(f'Keys: {sorted(keys)}')" 2>/dev/null || \
          oc get configmap $(params.CONFIGMAP_NAME) -n $(params.CONFIGMAP_NAMESPACE)
